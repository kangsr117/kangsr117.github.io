import cx from "classnames";
import * as React from "react";
import { ComponentProps, useRef, useState } from "react";
import { adaptive } from "../../../../../@tossteam/colors";
import useResizeObserver from "../../hooks/useResizeObserver";
import { MagnifierConsumer } from "../../providers/MagnifierContext";
import generateID from "../../utils/generateID";
import { BezierMask } from "../BezierMask.tsx";
import Txt from "../Text";
import GridListContent from "./GridListContent";

function GridListItem01({
  className,
  image,
  children,
  ...rest
}: ComponentProps<typeof GridListContent>) {
  const id = useRef(generateID("grid-item"));
  const ref = useRef<HTMLDivElement | null>(null);
  const [rect, setRect] = useState<
    { width: number; height: number } | undefined
  >(undefined);
  const [isOnPress, setIsOnPress] = useState(false);

  useResizeObserver(ref, ({ clientHeight, clientWidth }) => {
    if (
      rect === undefined ||
      rect.width !== clientWidth ||
      rect.height !== clientHeight
    ) {
      setRect({
        width: clientWidth,
        height: clientHeight,
      });
    }
  });

  return (
    <li
      className={cx("grid-list__item", className)}
      onTouchStart={() => {
        setIsOnPress(true);
      }}
      onTouchEnd={() => {
        setIsOnPress(false);
      }}
    >
      <GridListContent
        ref={ref}
        style={{ clipPath: `url(#${id.current})` }}
        image={image}
        {...rest}
      >
        {children}
      </GridListContent>
      {rect !== undefined ? (
        <BezierMask
          id={id.current}
          width={rect.width}
          height={rect.height}
          radius={12}
        />
      ) : null}
      <MagnifierConsumer visible={isOnPress}>
        <div className="magnified-grid-item">
          <img className="magnified-grid-item__image" {...image} />
          <Txt typography="t3" fontWeight="medium" color={adaptive.grey700}>
            {children}
          </Txt>
        </div>
      </MagnifierConsumer>
    </li>
  );
}

export default GridListItem01;
