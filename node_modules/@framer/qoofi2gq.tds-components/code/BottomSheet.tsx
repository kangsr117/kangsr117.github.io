import styled from '@emotion/styled';
import { addPropertyControls, ControlType, useIsInCurrentNavigationTarget, useNavigation } from 'framer';
import * as React from 'react';
import { ReactNode, useEffect, useState } from 'react';
import { colors } from '../@tossteam/colors';
import { default as TDSBottomSheet } from '../@tossteam/tds-web/react/components/BottomSheet';
import { default as TDSAgreement } from '../@tossteam/tds-web/react/components/NewAgreement';
import { default as Txt } from '../@tossteam/tds-web/react/components/Text';
import convertNewLineToJSX from '../@tossteam/tds-web/react/utils/convertNewLineToJSX';
import { ChildrenPlaceholder } from '../src/components/ChildrenPlaceholder';
import { IPhoneSafeAreaContainer } from '../src/components/iPhoneSafeAreaContainer';
import { TDSComponent } from '../src/components/TDSComponent';
import { useFilteringEventHandlersInInspector } from '../src/hooks/useFilteringEventHandlersInInspector';
import '../src/styles/tds-framer.css';
import { isStaticRenderTarget } from '../src/utils/isStaticRenderTarget';
import { makeComponentDisplayName } from '../src/utils/makeDisplayName';
import {
  Button,
  styleByControlLabel as buttonStyleByControlLabel,
  StyleLabel as ButtonStyleLabel,
  styleLabels as buttonStyleLabels,
  typeByControlLabel as buttonTypeByControlLabel,
  TypeLabel as ButtonTypeLabel,
  typeLabels as buttonTypeLabels,
} from './Button';

const typeLabels = ['ì»¤ìŠ¤í…€', 'ê¸€', 'ì…€ë ‰í„°', 'ì•½ê´€'] as const;
const headerTypeLabels = ['ì—†ìŒ', 'íƒ€ì´í‹€', 'íƒ€ì´í‹€ + ì„¤ëª…'] as const;

type TypeLabel = typeof typeLabels[number];
type HeaderTypeLabel = typeof headerTypeLabels[number];

interface Props {
  type: TypeLabel;
  headerType: HeaderTypeLabel;
  title: string;
  description: string;

  bodyText: string;

  selectorOptions: string;
  selectorSelectedIndex: number;

  agreementItems: string;

  showCTA: boolean;
  showCTAOptions: boolean;
  onlyOneButton: boolean;
  buttonText: string;
  rightButtonText: string;
  rightButtonType: ButtonTypeLabel;
  rightButtonStyle: ButtonStyleLabel;
  rightButtonEnabled: boolean;
  leftButtonText: string;
  leftButtonType: ButtonTypeLabel;
  leftButtonStyle: ButtonStyleLabel;
  leftButtonEnabled: boolean;

  iPhoneSafeAreaPadding: boolean;
  showDimmer: boolean;

  content: ReactNode;

  onDimmerClick?: () => void;
  onCTA_ButtonClick: () => void;
  onCTA_RightButtonClick: () => void;
  onCTA_LeftButtonClick: () => void;
}

function getHeaderComponent({ headerType, title, description }: Props) {
  return (
    <>
      {headerType !== 'ì—†ìŒ' && (
        <TDSBottomSheet.Header hasCloseButton={false}>{convertNewLineToJSX(title)}</TDSBottomSheet.Header>
      )}
      {headerType === 'íƒ€ì´í‹€ + ì„¤ëª…' && (
        <TDSBottomSheet.HeaderDescription>{convertNewLineToJSX(description)}</TDSBottomSheet.HeaderDescription>
      )}
    </>
  );
}

function getContentComponent({
  type,
  headerType,

  bodyText,

  selectorOptions,
  selectorSelectedIndex,

  agreementItems,

  showCTA,
  content,
}: Props) {
  const [value, setValue] = React.useState(selectorSelectedIndex - 1);
  React.useEffect(() => {
    setValue(selectorSelectedIndex - 1);
  }, [selectorSelectedIndex]);

  switch (type) {
    case 'ì»¤ìŠ¤í…€':
      return (
        <Content>
          {React.Children.count(content) > 0 ? (
            content
          ) : (
            <BottomSheetContentPlaceholder bigRadius={headerType === 'ì—†ìŒ' || !showCTA} />
          )}
        </Content>
      );
    case 'ê¸€':
      const topMargin = headerType === 'ì—†ìŒ' ? 24 : 0;
      const bottomMargin = !showCTA ? 30 : 0;
      return (
        <Txt
          typography="t5"
          color={colors.grey700}
          style={{
            margin: `${topMargin}px 24px ${bottomMargin}px 24px`,
            whiteSpace: 'pre-wrap',
          }}
        >
          {bodyText}
        </Txt>
      );
    case 'ì…€ë ‰í„°':
      return (
        <TDSBottomSheet.Select
          value={String(value)}
          onChange={e => setValue(Number(e.target.value))}
          options={selectorOptions.split('\n').map((name, index) => ({ name, value: String(index) }))}
        />
      );
    case 'ì•½ê´€':
      return (
        <TDSAgreement>
          {agreementItems.split('\n').map(item => (
            <TDSAgreement.RowSmall>{item}</TDSAgreement.RowSmall>
          ))}
        </TDSAgreement>
      );
    default:
      return null;
  }
}

function getCTAComponent({
  showCTA,
  onlyOneButton,
  buttonText,
  rightButtonText,
  rightButtonType,
  rightButtonStyle,
  rightButtonEnabled,
  leftButtonText,
  leftButtonType,
  leftButtonStyle,
  leftButtonEnabled,

  onCTA_ButtonClick,
  onCTA_RightButtonClick,
  onCTA_LeftButtonClick,
}: Props) {
  if (!showCTA) {
    return null;
  }

  return onlyOneButton ? (
    <TDSBottomSheet.CTA
      type={buttonTypeByControlLabel[rightButtonType]}
      style={buttonStyleByControlLabel[rightButtonStyle]}
      disabled={!rightButtonEnabled}
      onClick={onCTA_ButtonClick}
      hasSafeAreaPadding
    >
      {buttonText}
    </TDSBottomSheet.CTA>
  ) : (
    <TDSBottomSheet.CTA.TypeB
      leftButton={
        <Button
          text={leftButtonText}
          type={leftButtonType}
          style={leftButtonStyle}
          disabled={leftButtonEnabled ? 'í™œì„±' : 'ë¹„í™œì„±'}
          onClick={onCTA_LeftButtonClick}
          disableInspector
        />
      }
      rightButton={
        <Button
          text={rightButtonText}
          type={rightButtonType}
          style={rightButtonStyle}
          disabled={rightButtonEnabled ? 'í™œì„±' : 'ë¹„í™œì„±'}
          onClick={onCTA_RightButtonClick}
          disableInspector
        />
      }
    />
  );
}

export function BottomSheet(originalProps: Props) {
  const props = useFilteringEventHandlersInInspector(originalProps);
  const {
    headerType,
    title,
    description,
    showCTA,
    onlyOneButton,
    rightButtonText,
    rightButtonType,
    rightButtonStyle,
    rightButtonEnabled,
    leftButtonText,
    leftButtonType,
    leftButtonStyle,
    leftButtonEnabled,
    showDimmer,
    onDimmerClick,
  } = props;

  const navigation = useNavigation();
  const isInCurrentNavigationTarget = useIsInCurrentNavigationTarget();

  const withoutAnimation = isStaticRenderTarget() || !props.showDimmer;
  const [open, setOpen] = useState(withoutAnimation);
  const [shouldGoBackOnExited, setShouldGoBackOnExited] = useState(false);
  useEffect(() => {
    if (withoutAnimation) {
      return;
    }

    const timeoutHandler = setTimeout(() => {
      setOpen(true);
      if (onDimmerClick === undefined) {
        setShouldGoBackOnExited(true);
      }
    }, 100);

    return () => {
      setShouldGoBackOnExited(false);
      clearTimeout(timeoutHandler);
    };
  }, [isInCurrentNavigationTarget]);

  return (
    <IPhoneSafeAreaContainer
      iPhoneX={props.iPhoneSafeAreaPadding}
      safeAreaHeight={props.showCTA ? 16 : undefined}
      safeAreaBackgroundColor="white"
    >
      <Container hideDimmer={!showDimmer} removeHeaderPadding={headerType === 'ì—†ìŒ'}>
        <TDSBottomSheet
          header={getHeaderComponent(props)}
          open={open}
          onClose={() => (onDimmerClick ?? setOpen)(false)}
          onExited={() => {
            if (shouldGoBackOnExited) {
              navigation.goBack();
              setShouldGoBackOnExited(false);
            }
          }}
          withoutAnimation={withoutAnimation}
        >
          <TDSComponent
            name="BottomSheet"
            summary={{
              title: headerType !== 'ì—†ìŒ' ? title : undefined,
              description: headerType === 'íƒ€ì´í‹€ + ì„¤ëª…' ? description : undefined,
              leftButton:
                showCTA && !onlyOneButton
                  ? {
                      type: buttonTypeByControlLabel[leftButtonType],
                      style: buttonStyleByControlLabel[leftButtonStyle],
                      disabled: !leftButtonEnabled,
                      text: leftButtonText,
                    }
                  : undefined,
              [onlyOneButton ? 'button' : 'rightButton']: showCTA
                ? {
                    type: buttonTypeByControlLabel[rightButtonType],
                    style: buttonStyleByControlLabel[rightButtonStyle],
                    disabled: !rightButtonEnabled,
                    text: rightButtonText,
                  }
                : undefined,
            }}
          >
            <>
              {getContentComponent(props)}
              {getCTAComponent(props)}
            </>
          </TDSComponent>
        </TDSBottomSheet>
      </Container>
    </IPhoneSafeAreaContainer>
  );
}

addPropertyControls(BottomSheet, {
  type: {
    title: 'ğŸ”¢ ì¢…ë¥˜',
    type: ControlType.Enum,
    displaySegmentedControl: true,
    options: typeLabels as any,
    defaultValue: typeLabels[0],
  },
  headerType: {
    title: 'ğŸ§¢ í—¤ë”',
    type: ControlType.Enum,
    displaySegmentedControl: true,
    options: headerTypeLabels as any,
    defaultValue: headerTypeLabels[1],
  },
  title: {
    title: 'ã€€ â†³ íƒ€ì´í‹€',
    type: ControlType.String,
    displayTextArea: true,
    defaultValue: 'ë°”í…€ì‹œíŠ¸ íƒ€ì´í‹€',
    hidden(props) {
      return props.headerType === 'ì—†ìŒ';
    },
  },
  description: {
    title: 'ã€€ â†³ ì„¤ëª…',
    type: ControlType.String,
    displayTextArea: true,
    defaultValue: 'ë°”í…€ì‹œíŠ¸ ì„¤ëª…',
    hidden(props) {
      return props.headerType !== 'íƒ€ì´í‹€ + ì„¤ëª…';
    },
  },

  bodyText: {
    title: 'ğŸ“ƒ ë³¸ë¬¸',
    type: ControlType.String,
    displayTextArea: true,
    defaultValue:
      'ë™í•´ë¬¼ê³¼ ë°±ë‘ì‚°ì´ ë§ˆë¥´ê³  ë‹³ë„ë¡ í•˜ëŠë‹˜ì´ ë³´ìš°í•˜ì‚¬ ìš°ë¦¬ë‚˜ë¼ ë§Œì„¸ ë¬´ê¶í™” ì‚¼ì²œë¦¬ í™”ë ¤ê°•ì‚° ëŒ€í•œì‚¬ëŒ ëŒ€í•œìœ¼ë¡œ ê¸¸ì´ ë³´ì „í•˜ì„¸ ë™í•´ë¬¼ê³¼ ë°±ë‘ì‚°ì´ ë§ˆë¥´ê³  ë‹³ë„ë¡ í•˜ëŠë‹˜ì´ ë³´ìš°í•˜ì‚¬ ìš°ë¦¬ë‚˜ë¼ ë§Œì„¸ ë¬´ê¶í™” ì‚¼ì²œë¦¬ í™”ë ¤ê°•ì‚° ëŒ€í•œì‚¬ëŒ ëŒ€í•œìœ¼ë¡œ ê¸¸ì´ ë³´ì „í•˜ì„¸',
    hidden(props) {
      return props.type !== 'ê¸€';
    },
  },

  selectorOptions: {
    title: 'âœ… ì…€ë ‰í„° ì˜µì…˜',
    type: ControlType.String,
    displayTextArea: true,
    defaultValue: 'ë™í•´ë¬¼ê³¼ ë°±ë‘ì‚°ì´\në§ˆë¥´ê³  ë‹³ë„ë¡\ní•˜ëŠë‹˜ì´ ë³´ìš°í•˜ì‚¬',
    hidden(props) {
      return props.type !== 'ì…€ë ‰í„°';
    },
  },
  selectorSelectedIndex: {
    title: 'ã€€ â†³ í¬ì»¤ìŠ¤',
    type: ControlType.Number,
    displayStepper: true,
    defaultValue: 1,
    min: 1,
    max: 10,
    hidden(props) {
      return props.type !== 'ì…€ë ‰í„°';
    },
  },

  agreementItems: {
    title: 'âœ… ì•½ê´€ ì˜µì…˜',
    type: ControlType.String,
    displayTextArea: true,
    defaultValue: 'ì œ3ì ì •ë³´ì œê³µ ë™ì˜ì„œ\nê°œì¸(ì‹ ìš©)ì •ë³´ ì œ3ì ì œê³µ\nì‚¬ì´ë²„í™˜ì „ ì´ìš©ì•ˆë‚´ ë° ìœ ì˜ì‚¬í•­',
    hidden(props) {
      return props.type !== 'ì•½ê´€';
    },
  },

  showCTA: {
    title: 'ğŸ…¿ï¸ í•˜ë‹¨CTA',
    type: ControlType.Boolean,
    enabledTitle: 'ON',
    disabledTitle: 'OFF',
    defaultValue: true,
  },
  showCTAOptions: {
    title: 'ã€€ â†³  ë²„íŠ¼ì˜µì…˜',
    type: ControlType.Boolean,
    enabledTitle: 'ë³´ê¸°',
    disabledTitle: 'ê°€ë¦¬ê¸°',
    defaultValue: false,
    hidden(props) {
      return !props.showCTA;
    },
  },
  onlyOneButton: {
    title: 'ğŸ•¹ ë²„íŠ¼ ê°œìˆ˜',
    type: ControlType.Boolean,
    enabledTitle: '1ê°œ',
    disabledTitle: '2ê°œ',
    defaultValue: true,
    hidden(props) {
      return !props.showCTAOptions;
    },
  },
  buttonText: {
    title: 'â†³ ë²„íŠ¼ í…ìŠ¤íŠ¸',
    type: ControlType.String,
    defaultValue: 'í™•ì¸',
    hidden(props) {
      return !props.showCTAOptions || !props.onlyOneButton;
    },
  },
  rightButtonText: {
    title: 'â†³ ì˜¤ë¥¸ìª½ í…ìŠ¤íŠ¸',
    type: ControlType.String,
    defaultValue: 'í•˜ê¸°',
    hidden(props) {
      return !props.showCTAOptions || props.onlyOneButton;
    },
  },
  rightButtonStyle: {
    title: 'ã€€ã€€â†³ íƒ€ì…',
    type: ControlType.Enum,
    displaySegmentedControl: true,
    options: buttonStyleLabels as any,
    defaultValue: buttonStyleLabels[0],
    hidden(props) {
      return !props.showCTAOptions;
    },
  },
  rightButtonType: {
    title: 'ã€€ã€€â†³ ìƒ‰ìƒ',
    type: ControlType.Enum,
    options: buttonTypeLabels as any,
    defaultValue: buttonTypeLabels[0],
    hidden(props) {
      return !props.showCTAOptions;
    },
  },
  rightButtonEnabled: {
    title: 'ã€€ã€€â†³ ìƒíƒœ',
    type: ControlType.Boolean,
    enabledTitle: 'í™œì„±',
    disabledTitle: 'ë¹„í™œì„±',
    defaultValue: true,
    hidden(props) {
      return !props.showCTAOptions;
    },
  },
  leftButtonText: {
    title: 'â†³ ì™¼ìª½ í…ìŠ¤íŠ¸',
    type: ControlType.String,
    defaultValue: 'ì•ˆí•˜ê¸°',
    hidden(props) {
      return !props.showCTAOptions || props.onlyOneButton;
    },
  },
  leftButtonStyle: {
    title: 'ã€€ã€€â†³ íƒ€ì…',
    type: ControlType.Enum,
    displaySegmentedControl: true,
    options: buttonStyleLabels as any,
    defaultValue: buttonStyleLabels[1],
    hidden(props) {
      return !props.showCTAOptions || props.onlyOneButton;
    },
  },
  leftButtonType: {
    title: 'ã€€ã€€â†³ ìƒ‰ìƒ',
    type: ControlType.Enum,
    options: buttonTypeLabels as any,
    defaultValue: buttonTypeLabels[1],
    hidden(props) {
      return !props.showCTAOptions || props.onlyOneButton;
    },
  },
  leftButtonEnabled: {
    title: 'ã€€ã€€â†³ ìƒíƒœ',
    type: ControlType.Boolean,
    enabledTitle: 'í™œì„±',
    disabledTitle: 'ë¹„í™œì„±',
    defaultValue: true,
    hidden(props) {
      return !props.showCTAOptions || props.onlyOneButton;
    },
  },
  iPhoneSafeAreaPadding: {
    title: 'ğŸ“± ì•„ì´í°X',
    type: ControlType.Boolean,
    enabledTitle: 'ON',
    disabledTitle: 'OFF',
    defaultValue: false,
  },
  showDimmer: {
    title: 'ğŸŒš Dimmer ë°°ê²½ ',
    type: ControlType.Boolean,
    enabledTitle: 'ì¼œê¸°',
    disabledTitle: 'ë„ê¸°',
    defaultValue: true,
  },

  content: {
    title: 'ìì‹ ì»¨í…ì¸ ',
    type: ControlType.ComponentInstance,
    hidden(props) {
      return props.type !== 'ì»¤ìŠ¤í…€';
    },
  },

  onDimmerClick: {
    type: ControlType.EventHandler,
  },
  onCTA_ButtonClick: {
    title: 'CTA Button Click',
    type: ControlType.EventHandler,
  },
  onCTA_RightButtonClick: {
    type: ControlType.EventHandler,
  },
  onCTA_LeftButtonClick: {
    type: ControlType.EventHandler,
  },
});

(BottomSheet as any).defaultProps = {
  width: 375,
  height: 667,
};

BottomSheet.displayName = makeComponentDisplayName('BottomSheet', 'ë°”í…€ì‹œíŠ¸');

const Container = styled.div<{
  hideDimmer: boolean;
  removeHeaderPadding: boolean;
}>`
  .modal__dimmer {
    background-color: rgba(0, 0, 0, 0.56);
    ${({ hideDimmer }) => (hideDimmer ? 'background: transparent;' : '')}
  }

  .bottom-sheet__header-wrapper {
    ${({ removeHeaderPadding }) => (removeHeaderPadding ? 'padding: 0;' : '')}
  }
`;

const Content = styled.div`
  & > div[data-framer-component-type='Frame'],
  & > div[data-framer-component-type='Stack'] {
    position: relative;
  }
`;

const BottomSheetContentPlaceholder = styled(ChildrenPlaceholder)<{
  bigRadius: boolean;
}>`
  height: 228px;
  border-radius: ${({ bigRadius }) => (bigRadius ? 16 : 6)}px;
  margin: ${({ bigRadius }) => (bigRadius ? 4 : 0)}px;
`;
